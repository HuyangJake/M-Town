(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{380:function(a,t,s){"use strict";s.r(t);var e=s(0),n=Object(e.a)({},function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("NSDistionary是非常熟悉常用的一个Foundation中的类，最显著的几个特点是：")]),a._v(" "),s("ul",[s("li",[a._v("以键值对存储数据")]),a._v(" "),s("li",[a._v("存储的数据具有唯一性")]),a._v(" "),s("li",[a._v("数据无序")])]),a._v(" "),s("p",[a._v("我们这次不是讲NSDictionary或NSMutableDictionary的方法，这些在"),s("a",{attrs:{href:"https://developer.apple.com/reference/foundation/nsdictionary?language=objc",target:"_blank",rel:"noopener noreferrer"}},[a._v("Apple API Reference"),s("OutboundLink")],1),a._v("中查询即可了解啦~\n我们来探索下NSDictionary的内部")]),a._v(" "),s("h2",{attrs:{id:"apple文档的启示"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apple文档的启示","aria-hidden":"true"}},[a._v("#")]),a._v(" Apple文档的启示")]),a._v(" "),s("p",[a._v("苹果貌似并不推荐我们去继承"),s("code",[a._v("NSDictionary")]),a._v("来使用其子类（苹果已经实现的子类："),s("code",[a._v("NSMutableDictionary")]),a._v("除外）")]),a._v(" "),s("blockquote",[s("p",[a._v("Before making a custom class of NSDictionary, investigate "),s("strong",[a._v("NSMapTable")]),a._v(" and the corresponding Core Foundation type, "),s("strong",[a._v("CFDictionary")]),a._v(". Because NSDictionary and CFDictionary are “toll-free bridged,” you can substitute a CFDictionary object for a NSDictionary object in your code (with appropriate casting). Although they are corresponding types, CFDictionary and NSDictionary do not have identical interfaces or implementations, and you can sometimes do things with CFDictionary that you cannot easily do with NSDictionary.")])]),a._v(" "),s("blockquote",[s("p",[a._v("If the behavior you want to add supplements that of the existing class, you could write a category on NSDictionary. Keep in mind, however, that this category will be in effect for all instances of NSDictionary that you use, and this might have unintended consequences. Alternatively, you could use composition to achieve the desired behavior.")])]),a._v(" "),s("p",[s("em",[a._v("大致意思是让我们想要给"),s("code",[a._v("NSDictionary")]),a._v("添加新功能就使用分类，不要继承子类。如果打算要继承"),s("code",[a._v("NSDictionary")]),a._v("，则需要好好研究下"),s("code",[a._v("NSMapTable")]),a._v("和相对应的Core Foundation类型："),s("code",[a._v("CFDictionary")])])]),a._v(" "),s("p",[s("code",[a._v("CFDictionary")]),a._v("是Core Foundation中的字典，和"),s("code",[a._v("NSDictionary")]),a._v("可以无代价转换，两者可以互相调用对方的方法创建和释放。可以使用"),s("code",[a._v("CFDictionary")]),a._v("来实现"),s("code",[a._v("NSDictionary")]),a._v("不容易实现的功能。·")]),a._v(" "),s("p",[a._v("另外苹果推荐让我们研究的"),s("a",{attrs:{href:"https://developer.apple.com/reference/foundation/nsmaptable?language=objc",target:"_blank",rel:"noopener noreferrer"}},[s("code",[a._v("NSMapTable")]),s("OutboundLink")],1),a._v("具体是什么呢?")]),a._v(" "),s("blockquote",[s("p",[a._v("The NSMapTable class is a mutable collection modeled after NSDictionary")])]),a._v(" "),s("p",[a._v("看到这句话刚开始我有点不解，NSMapTable竟是模仿NSDictionary的一个可变得集合，那跟NSMutableDictionary有什么不同啊？")]),a._v(" "),s("p",[a._v("NSMapTable与NSDictionary的几个不同点是：")]),a._v(" "),s("ul",[s("li",[a._v("可以weak的方式持有对象，当持有的对象的引用计数为0的时候，该对象会自动从集合中移除")]),a._v(" "),s("li",[a._v("key 和 value在输入的时候都可以copy，使用指针对做isEqual或者hashing对比")]),a._v(" "),s("li",[a._v("可以包含任何指针，不再仅仅局限于Objective-C的对象")])]),a._v(" "),s("p",[a._v("NSMapTable的初始化就可以指定 key 和 value 的持有方式")]),a._v(" "),s("p",[a._v("苹果提供了几个便捷的工厂方法")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//key strong， value strong")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("KeyType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" ObjectType"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("strongToStrongObjectsMapTable "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("NS_AVAILABLE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("_8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),a._v("_0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//key weak， value strong")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("KeyType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" ObjectType"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("weakToStrongObjectsMapTable "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("NS_AVAILABLE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("_8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),a._v("_0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// entries are not necessarily purged right away when the weak key is reclaimed")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//key strong， value weak")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("KeyType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" ObjectType"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("strongToWeakObjectsMapTable "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("NS_AVAILABLE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("_8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),a._v("_0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//key weak， value weak")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("KeyType"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" ObjectType"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("weakToWeakObjectsMapTable "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("NS_AVAILABLE")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("_8"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("6")]),a._v("_0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// entries are not necessarily purged right away when the weak key or object is reclaimed")]),a._v("\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br")])]),s("p",[a._v("或者像这样指定：")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//还可以指定NSMapTableCopyIn(添加前进行copy) ， 或者NSMapTableObjectPointerPersonality（使用指针去hashing）")]),a._v("\n NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("mapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("NSMapTable mapTableWithKeyOptions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("NSMapTableStrongMemory valueOptions"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("NSMapTableWeakMemory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n \n "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//需要一个对象到对象的映射集合，可以使用如下的mapTable")]),a._v("\n \n NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("objectToObjectMapping "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("NSMapTable mapTableWithStrongToStrongObjects"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("p",[a._v("同样类推，"),s("a",{attrs:{href:"https://developer.apple.com/reference/foundation/nshashtable?language=objc",target:"_blank",rel:"noopener noreferrer"}},[a._v("NSHashTable"),s("OutboundLink")],1),a._v("是对NSSet的模仿和衍生，扩展的功能与NSMapTable相同")]),a._v(" "),s("h2",{attrs:{id:"抛两个问题🙈"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#抛两个问题🙈","aria-hidden":"true"}},[a._v("#")]),a._v(" 抛两个问题🙈")]),a._v(" "),s("h4",{attrs:{id:"q：上千的对象存储到nsdictionary时，出现效率低下的问题是什么原因？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q：上千的对象存储到nsdictionary时，出现效率低下的问题是什么原因？","aria-hidden":"true"}},[a._v("#")]),a._v(" Q：上千的对象存储到NSDictionary时，出现效率低下的问题是什么原因？")]),a._v(" "),s("p",[a._v("直接先回答问题：因为存储的数量很多后hash表会出现比较多的冲突，解决大量冲突会占用大量CPU资源，造成效率低下。")]),a._v(" "),s("p",[s("a",{attrs:{href:"https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8",target:"_blank",rel:"noopener noreferrer"}},[a._v("hash表"),s("OutboundLink")],1),a._v("是什么？跟NSDictionary又有什么关系？")]),a._v(" "),s("p",[a._v("NSDictionary是使用hash表来实现key和value之间的映射和存储的。")]),a._v(" "),s("p",[a._v("hash表的基本思想是：将key作为关键字，放到hash函数ƒ(k)中计算得到结果为hash地址，然后将value值的地址存储到hash表中的ƒ(key)的hash地址中。")]),a._v(" "),s("p",[a._v("当关键字集合很大的时候，不同的关键字可能会通过hash函数映射到hash表的同一地址上。key1 ≠ key2, ƒ(key1) = ƒ(key2),这种情况称为冲突。冲突是不可避免的，只能通过改善哈希函数来减少冲突。（构造哈希函数方法请参考"),s("a",{attrs:{href:"https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8",target:"_blank",rel:"noopener noreferrer"}},[a._v("这里"),s("OutboundLink")],1),a._v("或查找其他资料）")]),a._v(" "),s("p",[a._v("然而有冲突必定是要解决的，不然新的值怎么存储到哈希表中呢。\n处理冲突主要有（查看原文请移步底部参考链接：哈希表）：")]),a._v(" "),s("ul",[s("li",[s("p",[s("strong",[a._v("开放定址法")])]),a._v(" "),s("ul",[s("li",[a._v("线性探测")]),a._v(" "),s("li",[a._v("平方探测")]),a._v(" "),s("li",[a._v("伪随机探测")])])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("单独链表法")])]),a._v(" "),s("p",[a._v("将散列到同一个存储位置的所有元素保存在一个链表中。实现时，一种策略是散列表同一位置的所有冲突结果都是用栈存放的，新元素被插入到表的前端还是后端完全取决于怎样方便。\n"),s("img",{attrs:{src:"http://jpkc.nwu.edu.cn/sjjg/study_online/book/8/4_2.files/image001.gif",alt:""}})])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("再哈希")])]),a._v(" "),s("p",[a._v("上一次哈希计算发生冲突后，使用另外的哈希函数进行哈希计算知道冲突不再发生")])]),a._v(" "),s("li",[s("p",[s("strong",[a._v("建立公共溢出区")])]),a._v(" "),s("p",[a._v("为冲突的哈希地址单独建立一块区域，所有冲突的哈希地址都存放在此区域中")])])]),a._v(" "),s("p",[a._v("到这里也就可以推断出，如果在NSDictionary存取时出现效率低下的情况，那么很可能是： 1.频繁的扩容 2.冲突过多")]),a._v(" "),s("h4",{attrs:{id:"q：nsmaptable是怎样的结构呢？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#q：nsmaptable是怎样的结构呢？","aria-hidden":"true"}},[a._v("#")]),a._v(" Q：NSMapTable是怎样的结构呢？")]),a._v(" "),s("p",[s("strong",[a._v("先来看看NSMapTable的结构")]),a._v("(代码来自于cocotron)\nNSMapTable是一个key－value的容器，下面是NSMapTable的部分代码：")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("typedef")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n   NSMapTable        "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   NSInteger                i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" _NSMapNode "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("j"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" NSMapEnumerator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[a._v("上述结构体描述了遍历一个NSMapTable时的一个指针对象，其中包含table对象自身的指针，计数值，和节点指针。")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("typedef")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n   NSUInteger "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("hash"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   BOOL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("isEqual"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("retain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("release"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   NSString  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("describe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("notAKeyMarker"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" NSMapTableKeyCallBacks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("p",[a._v("上述结构体中存放的是几个函数指针，用于计算key的hash值，判断key是否相等，retain，release操作。")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("typedef")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v("       "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("retain"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v("       "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("release"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   NSString  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("describe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSMapTable "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("table"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("const")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v(" NSMapTableValueCallBacks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br")])]),s("p",[a._v("上述存放的三个函数指针，定义在对nsmaptable插入一对key－value时，对value对象的操作。")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("@interface")]),a._v(" NSMapTable "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" NSObject "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n   NSMapTableKeyCallBacks   "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("keyCallBacks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   NSMapTableValueCallBacks "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("valueCallBacks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   NSUInteger             count"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   NSUInteger             nBuckets"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("struct")]),a._v(" _NSMapNode  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v("buckets"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("p",[a._v("上面是NSMtabtable真正的描述，可以看出来NSMapTable是一个哈希＋链表的数据结构(也就是使用Hash表中的单链表法解决冲突)，因此在NSMapTable中插入或者删除一对对象时")]),a._v(" "),s("p",[a._v("寻找的时间是O（1）＋O（m），m最坏时可能为n。")]),a._v(" "),s("p",[a._v("O（1）：为对key进行hash得到bucket的位置\nO（m）：遍历该bucket后面冲突的value，通过链表连接起来。")]),a._v(" "),s("p",[a._v("因此：NSDictionary中的key Value遍历时是无序的，至如按照什么样的顺序，跟hash函数相关。NSMapTable使用NSObject的哈希函数。")]),a._v(" "),s("div",{staticClass:"language-objectivec line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-objectivec"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSUInteger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("hash "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n   "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("return")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("NSUInteger"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("self")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("p",[a._v("上述是NSObject的哈希值的计算方式，简单通过移位实现。右移4位，左边补0.\n因为对象大多存于堆中，地址相差4位应该很正常。")]),a._v(" "),s("p",[a._v("参考：")]),a._v(" "),s("p",[s("a",{attrs:{href:"http://www.isaced.com/post-235.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("NSMapTable: more than an NSDictionary for weak pointers"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://developer.apple.com/reference/foundation/nsmaptable?language=objc",target:"_blank",rel:"noopener noreferrer"}},[a._v("Apple API Reference - NSMapTable"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://developer.apple.com/reference/foundation/nshashtable?language=objc",target:"_blank",rel:"noopener noreferrer"}},[a._v("Apple API Reference - NSHashTable"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"https://zh.wikipedia.org/wiki/%E5%93%88%E5%B8%8C%E8%A1%A8",target:"_blank",rel:"noopener noreferrer"}},[a._v("维基百科 - 哈希表"),s("OutboundLink")],1),a._v("(需要翻下墙，也可以问下度娘)")]),a._v(" "),s("p",[s("a",{attrs:{href:"http://ibloodline.com/articles/2016/07/11/NSDictionary.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("关于NSDictionary"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("a",{attrs:{href:"http://www.cnblogs.com/doudouyoutang/p/4379068.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("NSDictionary 的内部实现"),s("OutboundLink")],1)]),a._v(" "),s("p",[s("em",[a._v("《Objective-C高级编程：iOS与OS X多线程和内存管理》 ARC的实现")])])])},[],!1,null,null,null);t.default=n.exports}}]);